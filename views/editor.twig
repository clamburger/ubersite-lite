{% extends "master.twig" %}

{% block head %}
  <script src='/resources/js/editor.js'></script>
{% endblock %}

{% block title %}Questionnaire Editor{% endblock %}

{% block content %}

  {% if showAll %}

    {# List of questionnaires #}

    {% if questionnaires | length > 0 %}
      <table class="progress">
        <tr>
          <th>ID</th>
          <th>Title</th>
          <th>Pages</th>
          <th>Controls</th>
        </tr>
        {% for questionnaire in questionnaires %}
        <tr>
          <th>{{ questionnaire.id }}</th>
          <td><a href='/editor/{{ questionnaire.id }}'>{{ questionnaire.title }}</a></td>
          <td>{{ questionnaire.pages | length }}</td>
          <td>
            <button data-action="duplicate" data-id="{{ questionnaire.id }}">Duplicate</button>
            <button data-action="delete" data-id="{{ questionnaire.id }}">Delete</button>
          </td>
        </tr>
        {% endfor %}
      </table>
    {% else %}
      <p>There are currently no questionnaires.</p>
    {% endif %}
    <button data-action="create-questionnaire">Create new questionnaire</button>

  {% else %}

    <input type="hidden" id="questionnaire-id" value="{{ questionnaire.id }}" />

    {% if page %}

      {# Editing a single page in a questionnaire #}

      <input type="hidden" id="page-number" value="{{ pageNumber }}" />
      <table style='float: right;' class='progress'>
        <tr><th colspan="2">Questionnaire Pages:</th></tr>
        {% for pageRow in questionnaire.pages %}
          <tr>
            {% if loop.index == pageNumber %}
            <td>{{ loop.index }}. <strong>{{ pageRow.title }}</strong></td>
            {% else %}
            <td>{{ loop.index }}. <a href='/editor/{{ questionnaire.id }}/{{ loop.index }}'>{{ pageRow.title }}</td>
            {% endif %}
            <td>{{ pageRow.sections | length }} section{{ pageRow.sections | length == 1 ? '' : 's' }}</td>
          </tr>
        {% endfor %}
          <tr>
            <td colspan="2"><a href='/editor/{{ questionnaire.id }}' style='color: maroon'>Back to the list of pages</a></td>
          </tr>
      </table>
      <h2>{{ questionnaire.title }}</h2>
      <table class="progress">
        <tr>
          <th><label for="title-editor">Page Title</label></th>
          <td><input type="text" id="title-editor" value="{{ page.title }}" class="h2" /></td>
          <td>
            <button id="save-page-title">Save title</button>
          </td>
        </tr>
        <tr>
          <th><label for="intro-text-editor">Page Intro</label></th>
          <td><textarea id="intro-text-editor">{{ page.intro }}</textarea></td>
          <td>
            <button id="save-page-intro">Save intro text</button>
          </td>
        </tr>
      </table>

      {# Section workspace #}

      <div class="editor-workspace">
      {% for section in page.sections %}
        <div class="editor-section">
          <div class="editor-section-controls">
            <button data-action="duplicate-section" data-id="{{ loop.index0 }}">Duplicate</button>
            <button data-action="delete-section" data-id="{{ loop.index0 }}">Delete</button>
          </div>
          <input class="h3 invisible" value="{{ section.title }}" />
          <ul>
          {% for question in section.questions %}
            <li>{{ question.question }}</li>
          {% endfor %}
          {% if section.comments and section.border %}
            <li>Any other comments?</li>
          {% endif %}
          </ul>
        </div>
        <br>
      {% endfor %}
        <button id="add-section">Add a new section</button><br>
      </div>

    {% else %}

      {# Editing a questionnaires; viewing the list of pages #}

      <table class="progress">
        <tr>
          <th><label for="title-editor">Title</label></th>
          <td><input type="text" id="title-editor" value="{{ questionnaire.title }}" class="h2" /></td>
          <td>
            <button id="save-title">Save title</button>
          </td>
        </tr>
        <tr>
          <th><label for="intro-text-editor">Intro Text</label></th>
          <td><textarea id="intro-text-editor">{{ questionnaire.intro }}</textarea></td>
          <td>
            <button id="save-intro-text">Save intro text</button>
          </td>
        </tr>
      </table>

      {% if questionnaire.pages | length > 0 %}
        <table class="progress">
          <tr>
            <th>&nbsp;</th>
            <th>Page Title</th>
            <th>Sections</th>
            <th>Controls</th>
          </tr>
          {% for page in questionnaire.pages %}
            <tr>
              <th>{{ loop.index }}</th>
              <td><a href='/editor/{{ questionnaire.id }}/{{ loop.index }}'>{{ page.title }}</a></td>
              <td>{{ page.sections | length }}</td>
              <td>
                <button data-action="move-page" data-id="{{ loop.index }}" data-movement="-1">&uarr;</button>
                <button data-action="move-page" data-id="{{ loop.index }}" data-movement="1">&darr;</button>
                <button data-action="page-duplicate" data-id="{{ loop.index }}">Duplicate</button>
                <button data-action="page-delete" data-id="{{ loop.index }}">Delete</button>
              </td>
            </tr>
          {% endfor %}
        </table>
      {% else %}
        <p>This questionnaire doesn't have any pages yet.</p>
      {% endif %}
      <button data-action="page-create">Create new page</button>
    {% endif %}
  {% endif %}
{% endblock %}
